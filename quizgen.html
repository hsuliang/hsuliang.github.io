<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å­¸å¹³å°æ¸¬é©—é¡Œç›®ç”Ÿæˆå™¨ v5.3 (Multi-AI) | ç‚ºè€å¸«è¨­è¨ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS/xlsx library for creating .xlsx files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- pdf.js for reading PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f3ff; /* Fallback */
            background-image: linear-gradient(to top right, #f5f3ff, #eef2ff); /* Gradient background */
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366f1; /* Indigo color for loader */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-preview-item {
            position: relative;
        }
        .remove-image-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
            transition: background-color 0.2s;
        }
        .remove-image-btn:hover {
            background-color: rgba(239, 68, 68, 0.9); /* Red on hover */
        }
        .tab-btn {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
        }
        .tab-btn.active {
            color: #4f46e5; /* indigo-600 */
            border-bottom-color: #4f46e5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-700">æ•™å­¸å¹³å°æ¸¬é©—é¡Œç›®ç”Ÿæˆå™¨</h1>
            <p class="text-lg text-gray-500 mt-3"> è¶…æ–¹ä¾¿ç”Ÿæˆå™¨ï¼Œä¸€éµç”Ÿæˆ Wordwallã€Kahootã€Waygroundã€LoiLoNote æ ¼å¼æ¸¬é©— </p>
        </header>

        <!-- Main Content Layout -->
        <main class="max-w-4xl mx-auto space-y-8">

            <!-- Step 0: API Key Input -->
            <div class="bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-indigo-600 flex items-center"><span class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3">ğŸ”‘</span>å•Ÿç”¨ AI åŠŸèƒ½</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="ai-provider-select" class="block text-sm font-medium text-gray-700">AI æ¨¡å‹ä¾›æ‡‰å•†ï¼š</label>
                        <select id="ai-provider-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="google" selected>Google Gemini</option>
                            <option value="openai">OpenAI (ChatGPT)</option>
                        </select>
                    </div>
                    <div>
                        <label for="api-key-input" class="block text-sm font-medium text-gray-700">API é‡‘é‘° (å¿…å¡«)ï¼š</label>
                        <input type="password" id="api-key-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="è«‹è²¼ä¸Šæ‚¨é¸æ“‡çš„ä¾›æ‡‰å•†é‡‘é‘°">
                    </div>
                </div>
                 <p id="api-key-help-text" class="text-xs text-gray-500 mt-2">æ‚¨å¯ä»¥å¾ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 underline">Google AI Studio</a> å…è²»å–å¾—é‡‘é‘°ã€‚</p>
            </div>

            <!-- Step 1: Input -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold mb-5 text-indigo-600 flex items-center"><span class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3">1</span>æä¾›å…§å®¹</h2>
                
                <!-- Tabs for Input Method -->
                <div class="border-b border-gray-200 mb-6 overflow-x-auto">
                    <nav class="-mb-px flex space-x-2 md:space-x-4" aria-label="Tabs">
                        <button id="tab-paste-text" class="tab-btn active">ğŸ“‹ è²¼ä¸Šæ–‡å­—</button>
                        <button id="tab-upload-file" class="tab-btn">ğŸ“„ ä¸Šå‚³æª”æ¡ˆ</button>
                        <button id="tab-upload-image" class="tab-btn">ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡</button>
                        <button id="tab-ai-generate" class="tab-btn">âœ¨ AIç”Ÿæˆå…§æ–‡</button>
                    </nav>
                </div>

                <!-- Tab 1: Paste Text -->
                <div id="content-paste-text" class="tab-content active">
                    <label for="text-input" class="block text-sm font-medium text-gray-700 mb-1">è²¼ä¸Šæ–‡ç« æˆ–æ•™å­¸å…§å®¹ï¼š</label>
                    <textarea id="text-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„æ•™å­¸æ–‡å­—å…§å®¹..."></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="copy-content-btn" class="bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 transition duration-300 flex items-center text-sm hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            è¤‡è£½æ–‡ç« å…§å®¹
                        </button>
                    </div>
                </div>

                <!-- Tab 2: Upload File -->
                <div id="content-upload-file" class="tab-content">
                     <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">ä¸Šå‚³æ–‡å­—æª”ï¼š</label>
                    <label for="file-input" class="flex flex-col items-center justify-center w-full h-48 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-lg appearance-none cursor-pointer hover:border-indigo-400 focus:outline-none hover:bg-indigo-50">
                        <span class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span class="font-medium text-gray-600">
                                é»æ“Šæ­¤è™•ä¸Šå‚³æ–‡å­—æª”
                                <span class="text-indigo-600">æˆ–æ‹–æ›³æª”æ¡ˆåˆ°é€™è£¡</span>
                            </span>
                        </span>
                         <p class="text-xs text-gray-500 mt-1">æ”¯æ´ .txt åŠ .pdf æ ¼å¼</p>
                    </label>
                    <input type="file" id="file-input" class="hidden" accept=".txt,.pdf">
                    <p id="file-name-display" class="mt-2 text-sm text-center text-gray-600"></p>
                </div>

                <!-- Tab 3: Upload Image -->
                <div id="content-upload-image" class="tab-content">
                    <label for="image-input" class="block text-sm font-medium text-gray-700 mb-2">ä¸Šå‚³åœ–ç‰‡ (æ”¯æ´å¤šå¼µåœ–ç‰‡)ï¼š</label>
                    <label for="image-input" class="flex flex-col items-center justify-center w-full h-32 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-lg appearance-none cursor-pointer hover:border-indigo-400 focus:outline-none hover:bg-indigo-50">
                        <span class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="font-medium text-gray-600">
                                é»æ“Šæ­¤è™•ä¸Šå‚³åœ–ç‰‡
                                <span class="text-indigo-600">æˆ–æ‹–æ›³æª”æ¡ˆåˆ°é€™è£¡</span>
                            </span>
                        </span>
                         <p class="text-xs text-gray-500 mt-1">æ”¯æ´ .jpg, .png, .gif, .webp æ ¼å¼ (åƒ…é™ Google Gemini æ¨¡å‹)</p>
                    </label>
                    <input type="file" id="image-input" class="hidden" accept="image/*" multiple>
                    <div id="image-preview-container" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                </div>
                
                <!-- Tab 4: AI Generate Content -->
                <div id="content-ai-generate" class="tab-content">
                    <div class="space-y-4">
                         <div>
                            <label for="topic-input" class="block text-sm font-medium text-gray-700 mb-1">è«‹è¼¸å…¥æ¸¬é©—ä¸»é¡Œã€å–®å­—æˆ–èªè©ï¼š</label>
                            <input type="text" id="topic-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="ä¾‹å¦‚ï¼šå…‰åˆä½œç”¨ã€æ°¸çºŒç™¼å±•ã€apple, banana, run...">
                        </div>
                        <div>
                            <label for="student-level-select" class="block text-sm font-medium text-gray-700 mb-1">è«‹é¸æ“‡å­¸ç”Ÿç¨‹åº¦ (K12)ï¼š</label>
                            <select id="student-level-select" class="w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="1-2" selected>ä½å¹´ç´š</option>
                                <option value="3-4">ä¸­å¹´ç´š</option>
                                <option value="5-6">é«˜å¹´ç´š</option>
                                <option value="7-9">åœ‹ä¸­</option>
                                <option value="9-12">é«˜ä¸­</option>
                            </select>
                        </div>
                        <button id="generate-content-btn" class="w-full bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-300 flex items-center justify-center">
                           <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                            </svg>
                            ç”Ÿæˆå­¸ç¿’å…§æ–‡
                        </button>
                        <p class="text-xs text-center text-gray-500">AI å°‡æ ¹æ“šæ‚¨çš„è¼¸å…¥ç”Ÿæˆå­¸ç¿’çŸ­æ–‡ï¼Œä¸¦è‡ªå‹•å¡«å…¥ã€Œè²¼ä¸Šæ–‡å­—ã€é ç±¤ä¸­ã€‚</p>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Options -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold mb-5 text-indigo-600 flex items-center"><span class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3">2</span>è¨­å®šé¸é …</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="num-questions" class="block text-sm font-medium text-gray-700">é¡Œç›®æ•¸é‡ï¼š</label>
                        <input type="number" id="num-questions" value="5" min="1" max="50" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="format-select" class="block text-sm font-medium text-gray-700">åŒ¯å‡ºæ ¼å¼ï¼š</label>
                        <select id="format-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-[50px]">
                            <option value="" disabled selected>è«‹é¸æ“‡...</option>
                            <option value="wordwall">Wordwall</option>
                            <option value="kahoot">Kahoot!</option>
                            <option value="wayground">Wayground</option>
                            <option value="loilonote">LoiLoNote</option>
                        </select>
                    </div>
                     <div>
                        <label for="question-type-select" class="block text-sm font-medium text-gray-700">é¡Œç›®é¡å‹ï¼š</label>
                        <select id="question-type-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-[50px]">
                            <option value="multiple_choice" selected>é¸æ“‡é¡Œ</option>
                            <option value="true_false">æ˜¯éé¡Œ</option>
                            <option value="mixed">æ˜¯é+é¸æ“‡é¡Œ</option>
                        </select>
                    </div>
                     <div>
                        <label for="difficulty-select" class="block text-sm font-medium text-gray-700">é¡Œç›®é›£åº¦ï¼š</label>
                        <select id="difficulty-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-[50px]">
                            <option value="ä¸­ç­‰" selected>ä¸­ç­‰ (é è¨­)</option>
                            <option value="ç°¡å–®">ç°¡å–®</option>
                            <option value="å›°é›£">å›°é›£</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 3: Generate and Download Button -->
            <div class="mt-8">
                <button id="generate-and-download-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:-translate-y-1 flex items-center justify-center text-xl shadow-lg hover:shadow-xl hover:shadow-indigo-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                       <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                    </svg>
                    âœ¨ ä¸€éµ AI ç”Ÿæˆä¸¦ä¸‹è¼‰
                </button>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p><span id="version-btn" class="cursor-pointer hover:text-indigo-600 hover:underline">v5.3 (Multi-AI)</span> | ç”± Google Gemini å¼·åŠ›é©…å‹• | <a href="https://bit.ly/Aliang" target="_blank" class="text-indigo-500 hover:underline">ä¸«äº®æ ¡é•·ç·´åŠŸåŠ</a></p>
        </footer>

    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader"></div>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">AI ç‚ºæ‚¨ç”Ÿæˆä¸­...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- Version History Modal -->
    <div id="version-modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 max-w-lg relative">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4">ç‰ˆæœ¬ä¿®æ­£æ­·ç¨‹</h3>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <div id="version-history-content" class="space-y-4 max-h-80 overflow-y-auto pr-4">
                <!-- History will be populated by script -->
            </div>
        </div>
    </div>


<script>
    // Set up pdf.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

    // DOM Elements
    const textInput = document.getElementById('text-input');
    const fileInput = document.getElementById('file-input');
    const fileNameDisplay = document.getElementById('file-name-display');
    const imageInput = document.getElementById('image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const numQuestionsInput = document.getElementById('num-questions');
    const formatSelect = document.getElementById('format-select');
    const generateAndDownloadBtn = document.getElementById('generate-and-download-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const versionBtn = document.getElementById('version-btn');
    const versionModal = document.getElementById('version-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const versionHistoryContent = document.getElementById('version-history-content');
    const questionTypeSelect = document.getElementById('question-type-select');
    const difficultySelect = document.getElementById('difficulty-select');
    const copyContentBtn = document.getElementById('copy-content-btn');
    const apiKeyInput = document.getElementById('api-key-input');
    const aiProviderSelect = document.getElementById('ai-provider-select');
    const apiKeyHelpText = document.getElementById('api-key-help-text');
    
    // New Tab Feature Elements
    const tabPasteText = document.getElementById('tab-paste-text');
    const tabUploadFile = document.getElementById('tab-upload-file');
    const tabUploadImage = document.getElementById('tab-upload-image');
    const tabAiGenerate = document.getElementById('tab-ai-generate');
    const contentPasteText = document.getElementById('content-paste-text');
    const contentUploadFile = document.getElementById('content-upload-file');
    const contentUploadImage = document.getElementById('content-upload-image');
    const contentAiGenerate = document.getElementById('content-ai-generate');
    const topicInput = document.getElementById('topic-input');
    const generateContentBtn = document.getElementById('generate-content-btn');
    const studentLevelSelect = document.getElementById('student-level-select');
    
    // --- Version History Data ---
    const versionHistory = [
        { version: "v5.3 (Multi-AI)", current: true, notes: ["ç¸®çŸ­ã€Œå•Ÿç”¨ AI åŠŸèƒ½ã€å€å¡Šçš„é«˜åº¦ï¼Œä½¿ä»‹é¢æ›´ç·Šæ¹Šã€‚", "å°‡å‰¯æ¨™é¡Œä¿®æ­£å›ã€Œå°ˆç‚ºåœ‹ä¸­å°è€å¸«è¨­è¨ˆ...ã€ã€‚"] },
        { version: "v5.2 (Multi-AI)", notes: ["ç°¡åŒ–è¼‰å…¥ç•«é¢ï¼Œä¿ç•™è½‰å‹•å‹•ç•«ä¸¦çµ±ä¸€æç¤ºæ–‡å­—ã€‚"] },
        { version: "v5.1 (Multi-AI)", notes: ["ç§»é™¤ Perplexity AI é¸é …ï¼Œå°ˆæ³¨æ–¼ä¸»æµæ¨¡å‹æ”¯æ´ã€‚"] },
        { version: "v5.0 (Multi-AI)", notes: ["âœ¨ã€é‡å¤§æ›´æ–°ã€‘æ”¯æ´å¤šç¨® AI æ¨¡å‹ï¼ç¾åœ¨æ‚¨å¯ä»¥é¸æ“‡ä½¿ç”¨ Google Gemini, OpenAI (ChatGPT) æˆ– Perplexityã€‚", "æ–°å¢ã€ŒAI æ¨¡å‹ä¾›æ‡‰å•†ã€ä¸‹æ‹‰é¸å–®ã€‚", "é‡æ§‹ API è«‹æ±‚é‚è¼¯ä»¥é©æ‡‰ä¸åŒä¾›æ‡‰å•†ã€‚"] },
        { version: "v4.2 (Standalone)", notes: ["âœ¨ é‡æ–°è¨­è¨ˆã€Œæä¾›å…§å®¹ã€å€å¡Šï¼Œå°‡è²¼ä¸Šæ–‡å­—ã€ä¸Šå‚³æª”æ¡ˆã€ä¸Šå‚³åœ–ç‰‡ã€AIç”Ÿæˆå…§æ–‡å„è‡ªç¨ç«‹ç‚ºé ç±¤ï¼Œå„ªåŒ–æ“ä½œæµç¨‹ã€‚"] },
        { version: "v4.1 (Standalone)", notes: ["å°‡ API é‡‘é‘°è¼¸å…¥æ¡†ç§»è‡³æœ€ä¸Šæ–¹ï¼Œä½œç‚ºç¨ç«‹çš„å•Ÿç”¨æ­¥é©Ÿã€‚"] },
        { version: "v4.0 (Standalone)", notes: ["âœ¨ æ–°å¢ API é‡‘é‘°è¼¸å…¥æ¡†ï¼Œä½¿ç¨‹å¼å¯å®Œå…¨è„«é›¢ Canvas ç’°å¢ƒç¨ç«‹é‹ä½œã€‚", "å„ªåŒ–éŒ¯èª¤æç¤ºï¼Œå¼•å°ä½¿ç”¨è€…ç”³è«‹ä¸¦å¡«å…¥è‡ªå·±çš„å…è²» API é‡‘é‘°ã€‚"] },
        { version: "v3.6", notes: ["ä¿®æ­£å¤§é‡å‡ºé¡Œæ™‚ï¼ˆå¦‚è¶…é20é¡Œï¼‰çš„ç”Ÿæˆå¤±æ•—å•é¡Œã€‚", "å„ªåŒ–æ‰¹æ¬¡ç”Ÿæˆé‚è¼¯ï¼Œç¢ºä¿ AI è«‹æ±‚çš„ç©©å®šæ€§ã€‚"] },
        { version: "v3.4", notes: ["âœ¨ æ–°å¢ã€Œè¤‡è£½æ–‡ç« å…§å®¹ã€æŒ‰éˆ•ï¼Œæ–¹ä¾¿è€å¸«å°‡ AI ç”Ÿæˆçš„å…§æ–‡åˆ†äº«è‡³å…¶ä»–å¹³å°ã€‚"] },
        { version: "v3.3", notes: ["âœ¨ æ–°å¢ã€Œæ˜¯é+é¸æ“‡é¡Œã€æ··åˆé¡Œå‹ã€‚", "èª¿æ•´é¡Œå‹é¸é …ï¼Œç§»é™¤ã€Œå¡«ç©ºé¡Œã€ã€‚"] }
    ];

    function populateVersionHistory() {
        let html = '';
        versionHistory.forEach(v => {
            html += `
                <div>
                    <h4 class="font-bold text-lg">${v.version} ${v.current ? '<span class="text-sm font-normal text-indigo-600">(ç›®å‰ç‰ˆæœ¬)</span>' : ''}</h4>
                    <ul class="list-disc list-inside text-gray-600">
                        ${v.notes.map(note => `<li>${note}</li>`).join('')}
                    </ul>
                </div>
            `;
        });
        versionHistoryContent.innerHTML = html;
    }
    
    function getApiKey() {
        const userKey = apiKeyInput.value.trim();
        if (!userKey) {
            throw new Error('API é‡‘é‘°ç‚ºå¿…å¡«é …ï¼è«‹å¾æ‚¨é¸æ“‡çš„ AI ä¾›æ‡‰å•†å–å¾—é‡‘é‘°ä¸¦è²¼å…¥æ¬„ä½ä¸­ã€‚');
        }
        return userKey;
    }
    
    function updateApiKeyHelpText() {
        const provider = aiProviderSelect.value;
        let link = '';
        let linkText = '';

        switch(provider) {
            case 'openai':
                link = 'https://platform.openai.com/api-keys';
                linkText = 'OpenAI Platform';
                break;
            case 'google':
            default:
                link = 'https://aistudio.google.com/app/apikey';
                linkText = 'Google AI Studio';
                break;
        }
        
        apiKeyHelpText.innerHTML = `æ‚¨å¯ä»¥å¾ <a href="${link}" target="_blank" class="text-indigo-600 underline">${linkText}</a> å…è²»å–å¾—é‡‘é‘°ã€‚`;
    }

    // --- Core API Configuration ---
    function getApiConfig() {
        const provider = aiProviderSelect.value;
        const apiKey = getApiKey();

        switch (provider) {
            case 'openai':
                return {
                    apiUrl: 'https://api.openai.com/v1/chat/completions',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    buildPayload: (systemPrompt, userParts, jsonSchema, model = 'gpt-4o') => {
                        const payload = {
                            model: model,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: userParts.map(p => p.text).join('\n') }
                            ],
                        };
                        if (jsonSchema) {
                            payload.response_format = { type: "json_object" };
                        }
                        return payload;
                    },
                    parseResponse: async (response, isJson) => {
                        const result = await response.json();
                        const content = result.choices?.[0]?.message?.content;
                        if (!content) throw new Error('AI å›æ‡‰ä¸­æ²’æœ‰æœ‰æ•ˆçš„å…§å®¹ã€‚');
                        return isJson ? JSON.parse(content).questions : content;
                    }
                };
            
            case 'google':
            default:
                return {
                    apiUrl: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`,
                    headers: { 'Content-Type': 'application/json' },
                    buildPayload: (systemPrompt, userParts, jsonSchema) => {
                        const payload = {
                            contents: [{ parts: userParts }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        };
                        if (jsonSchema) {
                           payload.generationConfig = { responseMimeType: "application/json", responseSchema: jsonSchema };
                        }
                        return payload;
                    },
                    parseResponse: async (response, isJson) => {
                         const result = await response.json();
                         const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                         if (!jsonText) throw new Error('API å›æ‡‰æ ¼å¼éŒ¯èª¤ã€‚');
                         return isJson ? JSON.parse(jsonText) : jsonText;
                    }
                };
        }
    }


    /**
     * âœ¨ New Feature: Generate learning content from a topic using Gemini API.
     */
    async function generateContentFromTopic() {
        const topic = topicInput.value;
        const studentLevel = studentLevelSelect.value;

        if (!topic.trim()) {
            showToast('è«‹è¼¸å…¥ä¸€å€‹ä¸»é¡Œã€å–®å­—æˆ–èªè©ï¼', 'error');
            return;
        }

        loadingOverlay.classList.remove('hidden');
        loadingText.textContent = 'AI ç‚ºæ‚¨ç”Ÿæˆå…§æ–‡ä¸­...';
        
        try {
            const config = getApiConfig();
            
            const wordCountMap = { '1-2': 200, '3-4': 400, '5-6': 600, '7-9': 800, '9-12': 1000 };
            const wordCount = wordCountMap[studentLevel];
            const studentGradeText = studentLevelSelect.options[studentLevelSelect.selectedIndex].text;
            let systemPrompt;
            const userQuery = `ä¸»é¡Œ/å–®å­—ï¼š${topic}`;
            const isWordList = topic.includes(',') || /^[a-zA-Z\s,]+$/.test(topic) && topic.split(/\s+|,/).filter(Boolean).length <= 10;
            
            if (isWordList) {
                systemPrompt = `ä½ æ˜¯ä¸€ä½ç‚ºK12å­¸ç”Ÿç·¨å¯«æ•™æçš„å‰µæ„å¯«ä½œå°ˆå®¶ã€‚è«‹ä½¿ç”¨ä½¿ç”¨è€…æä¾›çš„å–®å­—æˆ–èªè©ï¼Œç‚ºã€Œ${studentGradeText}ã€çš„å­¸ç”Ÿï¼Œæ’°å¯«ä¸€ç¯‡æœ‰è¶£ä¸”é€£è²«ã€é•·åº¦ç´„ç‚º ${wordCount} å­—çš„æ•…äº‹æˆ–é–±è®€çŸ­æ–‡ã€‚è«‹ç¢ºä¿é€™äº›è©å½™è‡ªç„¶åœ°èå…¥æ–‡ç« ä¸­ã€‚ä½ çš„å›æ‡‰åªèƒ½æœ‰æ–‡ç« æœ¬èº«ï¼Œä¸è¦åŒ…å«ä»»ä½•æ¨™é¡Œæˆ–é¡å¤–æ–‡å­—ã€‚`;
            } else {
                systemPrompt = `ä½ æ˜¯ä¸€ä½çŸ¥è­˜æ·µåšçš„æ•™æç·¨å¯«å°ˆå®¶ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…æä¾›çš„ä¸»é¡Œï¼Œç‚ºã€Œ${studentGradeText}ã€çš„å­¸ç”Ÿï¼Œç”Ÿæˆä¸€æ®µç´„ ${wordCount} å­—çš„ç°¡æ½”ç§‘æ™®çŸ­æ–‡ã€‚ä½ çš„å›æ‡‰åªèƒ½æœ‰æ–‡ç« æœ¬èº«ï¼Œä¸è¦åŒ…å«ä»»ä½•æ¨™é¡Œæˆ–é¡å¤–æ–‡å­—ã€‚`;
            }

            // For text generation, we don't pass a jsonSchema
            const payload = config.buildPayload(systemPrompt, [{ text: userQuery }]);

            const response = await fetch(config.apiUrl, {
                method: 'POST',
                headers: config.headers,
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if (response.status === 401) throw new Error('API è«‹æ±‚å¤±æ•— (401): æˆæ¬Šç„¡æ•ˆã€‚è«‹ç¢ºèªæ‚¨å¡«å¯«çš„ API é‡‘é‘°æ˜¯å¦æ­£ç¢ºã€‚');
                 const errorBody = await response.text();
                 console.error("API Error Body:", errorBody);
                throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status}`);
            }
            
            const generatedText = await config.parseResponse(response, false); // isJson = false

            if (generatedText) {
                textInput.value = generatedText;
                showToast('å­¸ç¿’å…§æ–‡å·²æˆåŠŸç”Ÿæˆï¼', 'success');
                copyContentBtn.classList.remove('hidden');
                tabPasteText.click();
            } else {
                throw new Error('AIæœªèƒ½ç”Ÿæˆå…§å®¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }

        } catch (error) {
            console.error('ç”Ÿæˆå…§æ–‡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            showToast(error.message, 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }


    /**
     * Main handler to start the generation and export process.
     */
    async function handleGenerateAndDownload() {
        const text = textInput.value;
        const totalQuestions = parseInt(numQuestionsInput.value, 10);
        const selectedFormat = formatSelect.value;
        const questionType = questionTypeSelect.value;
        const difficulty = difficultySelect.value;
        const provider = aiProviderSelect.value;

        if (!text.trim() && uploadedImages.length === 0) {
            showToast('è«‹å…ˆè¼¸å…¥æ–‡å­—ã€æˆ–ä¸Šå‚³åœ–ç‰‡ï¼', 'error');
            return;
        }
        if (uploadedImages.length > 0 && provider !== 'google') {
            showToast(`æ‚¨é¸æ“‡çš„ ${provider.charAt(0).toUpperCase() + provider.slice(1)} æ¨¡å‹ä¸æ”¯æ´åœ–ç‰‡è¼¸å…¥ï¼Œè«‹é¸æ“‡ Google Gemini æˆ–ç§»é™¤åœ–ç‰‡ã€‚`, 'error');
            return;
        }
        if (!selectedFormat) {
            showToast('è«‹é¸æ“‡åŒ¯å‡ºæª”æ¡ˆæ ¼å¼ï¼', 'error');
            return;
        }
        if (totalQuestions <= 0) {
            showToast('é¡Œç›®æ•¸é‡å¿…é ˆå¤§æ–¼ 0ï¼', 'error');
            return;
        }
        
        loadingOverlay.classList.remove('hidden');
        loadingText.textContent = 'AI ç‚ºæ‚¨ç”Ÿæˆé¡Œç›®ä¸­...';
        
        try {
            getApiKey(); // Check for API key before starting batch process
            
            const BATCH_SIZE = 8;
            const numBatches = Math.ceil(totalQuestions / BATCH_SIZE);
            let allGeneratedQs = [];

            for (let i = 0; i < numBatches; i++) {
                const questionsInBatch = Math.min(BATCH_SIZE, totalQuestions - allGeneratedQs.length);
                if (questionsInBatch <= 0) break;

                const batchResult = await generateSingleBatch(questionsInBatch, questionType, difficulty, text, uploadedImages, selectedFormat);
                allGeneratedQs = allGeneratedQs.concat(batchResult);
            }
            
            if (allGeneratedQs.length > 0) {
                exportFile(selectedFormat, questionType, allGeneratedQs);
            } else {
                throw new Error("AI æœªèƒ½ç”Ÿæˆä»»ä½•é¡Œç›®ï¼Œè«‹æª¢æŸ¥æ‚¨çš„è¼¸å…¥å…§å®¹æˆ–ç¨å¾Œå†è©¦ã€‚");
            }

        } catch(error) {
             console.error('ç”Ÿæˆé¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
             showToast(error.message, 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function generateSingleBatch(questionsInBatch, questionType, difficulty, text, images, selectedFormat) {
        const config = getApiConfig();
        const provider = aiProviderSelect.value;

        let systemPrompt, jsonSchema;
        const needsExplanation = selectedFormat === 'loilonote' || selectedFormat === 'wayground';
        
        const mcProperties = { text: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correct: { type: "ARRAY", items: { type: "INTEGER" } }, time: { type: "INTEGER" } };
        let mcRequired = ["text", "options", "correct", "time"];
        if (needsExplanation) { mcProperties.explanation = { type: "STRING" }; mcRequired.push("explanation");}
        const tfProperties = { text: { type: "STRING" }, is_correct: { type: "BOOLEAN" } };
        let tfRequired = ["text", "is_correct"];
        if (needsExplanation) { tfProperties.explanation = { type: "STRING" }; tfRequired.push("explanation");}

        const jsonSchemaText = (props) => JSON.stringify(props).replace(/"/g, "'");
        
        switch(questionType) {
            case 'true_false':
                jsonSchema = { type: "ARRAY", items: { type: "OBJECT", properties: tfProperties, required: tfRequired }};
                systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆé–€è¼¸å‡º JSON çš„åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…æä¾›çš„å…§å®¹ï¼Œç”Ÿæˆ${questionsInBatch}é¡Œ${difficulty}é›£åº¦çš„ã€Œæ˜¯éé¡Œã€ã€‚ä½ çš„å›æ‡‰å¿…é ˆæ˜¯ä¸€å€‹ JSON ç‰©ä»¶ï¼Œä¸”åªæœ‰ä¸€å€‹åç‚º "questions" çš„ keyï¼Œå…¶ value ç‚ºä¸€å€‹ JSON é™£åˆ—ã€‚é™£åˆ—ä¸­çš„æ¯å€‹ç‰©ä»¶éƒ½ä»£è¡¨ä¸€é¡Œæ˜¯éé¡Œï¼Œä¸”å¿…é ˆç¬¦åˆä»¥ä¸‹çµæ§‹ï¼š${jsonSchemaText(tfProperties)}ã€‚ä½ çš„å›æ‡‰å¿…é ˆæ˜¯ã€Œå–®ä¸€å€‹ã€JSON ç‰©ä»¶ï¼Œä¸åŒ…å«ä»»ä½•å‰å¾Œæ–‡ã€è¨»è§£æˆ– markdown æ¨™ç±¤ã€‚`;
                break;
            case 'mixed':
                 jsonSchema = { type: "ARRAY", items: { type: "OBJECT", properties: mcProperties, required: mcRequired }};
                 systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆé–€è¼¸å‡º JSON çš„åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…æä¾›çš„å…§å®¹ï¼Œç”Ÿæˆ${questionsInBatch}é¡Œ${difficulty}é›£åº¦çš„ã€Œé¸æ“‡é¡Œã€èˆ‡ã€Œæ˜¯éé¡Œã€æ··åˆé¡Œçµ„ã€‚æ˜¯éé¡Œè«‹ç”¨ ["æ˜¯", "å¦"] ä½œç‚ºé¸é …ã€‚ä½ çš„å›æ‡‰å¿…é ˆæ˜¯ä¸€å€‹ JSON ç‰©ä»¶ï¼Œä¸”åªæœ‰ä¸€å€‹åç‚º "questions" çš„ keyï¼Œå…¶ value ç‚ºä¸€å€‹ JSON é™£åˆ—ã€‚é™£åˆ—ä¸­çš„æ¯å€‹ç‰©ä»¶éƒ½ä»£è¡¨ä¸€é¡Œï¼Œä¸”å¿…é ˆç¬¦åˆä»¥ä¸‹çµæ§‹ï¼š${jsonSchemaText(mcProperties)}ã€‚ä½ çš„å›æ‡‰å¿…é ˆæ˜¯ã€Œå–®ä¸€å€‹ã€JSON ç‰©ä»¶ï¼Œä¸åŒ…å«ä»»ä½•å‰å¾Œæ–‡ã€è¨»è§£æˆ– markdown æ¨™ç±¤ã€‚`;
                break;
            case 'multiple_choice':
            default:
                 jsonSchema = { type: "ARRAY", items: { type: "OBJECT", properties: mcProperties, required: mcRequired }};
                 systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆé–€è¼¸å‡º JSON çš„åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…æä¾›çš„å…§å®¹ï¼Œç”Ÿæˆ${questionsInBatch}é¡Œ${difficulty}é›£åº¦çš„ã€Œé¸æ“‡é¡Œã€ã€‚æ¯é¡Œå¿…é ˆæœ‰4å€‹é¸é …ã€‚ä½ çš„å›æ‡‰å¿…é ˆæ˜¯ä¸€å€‹ JSON ç‰©ä»¶ï¼Œä¸”åªæœ‰ä¸€å€‹åç‚º "questions" çš„ keyï¼Œå…¶ value ç‚ºä¸€å€‹ JSON é™£åˆ—ã€‚é™£åˆ—ä¸­çš„æ¯å€‹ç‰©ä»¶éƒ½ä»£è¡¨ä¸€é¡Œé¸æ“‡é¡Œï¼Œä¸”å¿…é ˆç¬¦åˆä»¥ä¸‹çµæ§‹ï¼š${jsonSchemaText(mcProperties)}ã€‚ä½ çš„å›æ‡‰å¿…é ˆæ˜¯ã€Œå–®ä¸€å€‹ã€JSON ç‰©ä»¶ï¼Œä¸åŒ…å«ä»»ä½•å‰å¾Œæ–‡ã€è¨»è§£æˆ– markdown æ¨™ç±¤ã€‚`;
                break;
        }
        
        const userParts = [{ text: "è«‹æ ¹æ“šä»¥ä¸‹æä¾›çš„æ–‡å­—å’Œåœ–ç‰‡å…§å®¹å‡ºé¡Œã€‚" }];
        if(text.trim()){ userParts.push({ text: `æ–‡å­—å…§å®¹:\n${text}`}); }
        if (provider === 'google') { 
             images.forEach(img => {
                userParts.push({ inlineData: { mimeType: img.type, data: img.data } });
            });
        }
       
        const payload = config.buildPayload(systemPrompt, userParts, jsonSchema);

        const response = await fetch(config.apiUrl, {
            method: 'POST',
            headers: config.headers,
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
             if (response.status === 401) throw new Error('API è«‹æ±‚å¤±æ•— (401): æˆæ¬Šç„¡æ•ˆã€‚è«‹ç¢ºèªæ‚¨é¸æ“‡çš„ AI ä¾›æ‡‰å•†åŠå°æ‡‰çš„ API é‡‘é‘°æ˜¯å¦æ­£ç¢ºã€‚');
             const errorBody = await response.text();
             console.error("API Error Body:", errorBody);
             throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
        }

        try {
            return await config.parseResponse(response, true); // isJson = true
        } catch (e) {
            console.error("Failed to parse response:", e);
            throw new Error('API å›æ‡‰äº†ç„¡æ•ˆçš„æ ¼å¼ï¼Œè«‹å˜—è©¦æ¸›å°‘é¡Œç›®æ•¸é‡ã€‚');
        }
    }
    
    // --- File Handling (Text/PDF) ---
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) { fileNameDisplay.textContent = ''; return; }
        fileNameDisplay.textContent = `å·²é¸æ“‡æª”æ¡ˆï¼š${file.name}`;
        const reader = new FileReader();
        if (file.type === 'application/pdf') {
            reader.onload = async (e) => {
                const typedarray = new Uint8Array(e.target.result);
                try {
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ');
                    }
                    textInput.value = text;
                } catch (error) {
                    console.error("è®€å–PDFå¤±æ•—:", error);
                    showToast("ç„¡æ³•è®€å–æ­¤PDFæª”æ¡ˆã€‚", "error");
                    fileNameDisplay.textContent = '';
                }
            };
            reader.readAsArrayBuffer(file);
        } else { // Assume text file
            reader.onload = (e) => { textInput.value = e.target.result; };
            reader.readAsText(file);
        }
    });

    // --- Image Handling ---
    let uploadedImages = []; // To store { type, data } for each image
    imageInput.addEventListener('change', (event) => {
        const files = event.target.files;
        if (!files) return;
        imagePreviewContainer.innerHTML = '';
        uploadedImages = [];
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const fullBase64 = e.target.result;
                const base64Data = fullBase64.split(',')[1];
                const imageObject = { id: Date.now() + index, type: file.type, data: base64Data };
                uploadedImages.push(imageObject);
                const previewWrapper = document.createElement('div');
                previewWrapper.className = 'image-preview-item';
                const imgElement = document.createElement('img');
                imgElement.src = fullBase64;
                imgElement.className = 'w-full h-32 object-cover rounded-lg shadow-md';
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-image-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    uploadedImages = uploadedImages.filter(img => img.id !== imageObject.id);
                    previewWrapper.remove();
                };
                previewWrapper.appendChild(imgElement);
                previewWrapper.appendChild(removeBtn);
                imagePreviewContainer.appendChild(previewWrapper);
            };
            reader.readAsDataURL(file);
        });
    });


    // --- Export Function ---
    function exportFile(format, questionType, questions) {
        if (!questions || questions.length === 0) {
            showToast('æ²’æœ‰å¯åŒ¯å‡ºçš„é¡Œç›®ï¼', 'error');
            return;
        }
        let data, filename;
        try {
            const standardMCQs = questions.map(q => {
                if (q.hasOwnProperty('is_correct')) { // Check if it is a true/false question
                    return {
                        text: q.text,
                        options: ['æ˜¯', 'å¦'],
                        correct: [q.is_correct ? 0 : 1],
                        time: 30,
                        explanation: q.explanation || ''
                    };
                }
                return q; 
            });

            switch (format) {
                case 'wordwall':
                    data = standardMCQs.map(q => ({
                        'å•é¡Œ': q.text,
                        'é¸é …1': q.options[0] || '', 'é¸é …2': q.options[1] || '',
                        'é¸é …3': q.options[2] || '', 'é¸é …4': q.options[3] || '',
                        'æ­£ç¢ºé¸é …': q.correct.length > 0 ? (q.correct[0] + 1) : '',
                    }));
                    filename = 'Wordwall_Quiz.xlsx';
                    break;
                case 'kahoot':
                    const kahootData = [
                        ['Kahoot Quiz Template'], ['Add questions, answers, and time limits. Have fun!'], [], [],
                        ['Question', 'Answer 1', 'Answer 2', 'Answer 3', 'Answer 4', 'Time limit (sec)', 'Correct answer(s)']
                    ];
                    standardMCQs.forEach(q => {
                        kahootData.push([
                            q.text,
                            q.options[0] || '', q.options[1] || '', q.options[2] || '', q.options[3] || '',
                            q.time, q.correct.map(i => i + 1).join(',')
                        ]);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(kahootData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                    XLSX.writeFile(wb, 'Kahoot_Quiz.xlsx');
                    showToast('Kahoot æª”æ¡ˆå·²ä¸‹è¼‰ï¼', 'success');
                    return;
                case 'wayground':
                    data = standardMCQs.map(q => ({
                        'Question Text': q.text,
                        'Question Type': q.correct.length > 1 ? 'Checkbox' : 'Multiple Choice',
                        'Option 1': q.options[0] || '', 'Option 2': q.options[1] || '',
                        'Option 3': q.options[2] || '', 'Option 4': q.options[3] || '',
                        'Option 5': '', 'Correct Answer': q.correct.map(i => i + 1).join(','),
                        'Time in seconds': q.time, 'Image Link': '',
                        'Answer explanation': q.explanation || ''
                    }));
                    filename = 'Wayground_Quiz.xlsx';
                    break;
                case 'loilonote':
                    data = standardMCQs.map(q => ({
                        'å•é¡Œï¼ˆè«‹å‹¿ç·¨è¼¯æ¨™é¡Œï¼‰': q.text,
                        'å‹™å¿…ä½œç­”ï¼ˆè‹¥æ­¤å•é¡Œéœ€è¦å›ç­”ï¼Œè«‹è¼¸å…¥1ï¼‰': 1,
                        'æ¯é¡Œå¾—åˆ†ï¼ˆæœªå¡«å…¥çš„éƒ¨åˆ†å°‡è¢«è‡ªå‹•è¨­ç‚º1ï¼‰': 1,
                        'æ­£ç¢ºç­”æ¡ˆçš„é¸é …ï¼ˆè‹¥æœ‰è¤‡æ•¸æ­£ç¢ºç­”æ¡ˆé¸é …ï¼Œè«‹ç”¨ã€Œã€ã€æˆ–ã€Œ , ã€ä¾†åˆ†éš”é¸é …ç·¨è™Ÿï¼‰': q.correct.map(i => i + 1).join(','),
                        'èªªæ˜': q.explanation || '',
                        'é¸é …1': q.options[0] || '', 'é¸é …2': q.options[1] || '',
                        'é¸é …3': q.options[2] || '', 'é¸é …4': q.options[3] || '',
                    }));
                    filename = 'LoiLoNote_Quiz.xlsx';
                    break;
                default: throw new Error('Unknown format');
            }
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
            XLSX.writeFile(workbook, filename);
            showToast(`${format.charAt(0).toUpperCase() + format.slice(1)} æª”æ¡ˆå·²ä¸‹è¼‰ï¼`, 'success');
        } catch (error) {
            console.error('Export failed:', error);
            showToast('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤ã€‚', 'error');
        }
    };
    
    // --- Utility Functions ---
    function showToast(message, type = 'success') {
        toastMessage.textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        toast.classList.remove('opacity-0');
        setTimeout(() => { toast.classList.add('opacity-0'); }, 4000);
    }
    
    function copyContentToClipboard() {
        const textToCopy = textInput.value;
        if (!textToCopy.trim()) {
            showToast('æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½ï¼', 'error');
            return;
        }
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = textToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        try {
            document.execCommand('copy');
            showToast('æ–‡ç« å…§å®¹å·²æˆåŠŸè¤‡è£½ï¼', 'success');
        } catch (err) {
            console.error('è¤‡è£½å¤±æ•—:', err);
            showToast('ç„¡æ³•è¤‡è£½å…§å®¹ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚', 'error');
        } finally {
            document.body.removeChild(tempTextArea);
        }
    }

    // --- Initial setup on page load ---
    document.addEventListener('DOMContentLoaded', () => {
        populateVersionHistory();
        updateApiKeyHelpText(); // Initial call
    });

    // --- Event Listeners ---
    generateAndDownloadBtn.addEventListener('click', handleGenerateAndDownload);
    generateContentBtn.addEventListener('click', generateContentFromTopic);
    copyContentBtn.addEventListener('click', copyContentToClipboard);
    aiProviderSelect.addEventListener('change', updateApiKeyHelpText);

    // Tab switching logic
    const tabs = [tabPasteText, tabUploadFile, tabUploadImage, tabAiGenerate];
    const contents = [contentPasteText, contentUploadFile, contentUploadImage, contentAiGenerate];

    tabs.forEach((tab, index) => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            contents[index].classList.add('active');
        });
    });
    
    // Modal closing logic
    versionBtn.addEventListener('click', () => { versionModal.classList.remove('hidden'); });
    closeModalBtn.addEventListener('click', () => { versionModal.classList.add('hidden'); });
    versionModal.addEventListener('click', (event) => {
        if (event.target === versionModal) { versionModal.classList.add('hidden'); }
    });

</script>

</body>
</html>


