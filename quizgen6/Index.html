<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•™å­¸å¹³å°æ¸¬é©—é¡Œç›®ç”Ÿæˆå™¨ v6.0 (Server-Proxy)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Noto Sans TC',sans-serif;background:#f5f3ff;background-image:linear-gradient(to top right,#f5f3ff,#eef2ff)}
    .loader{border:5px solid #f3f3f3;border-top:5px solid #6366f1;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .image-preview-item{position:relative}
    .remove-image-btn{position:absolute;top:-.5rem;right:-.5rem;background:rgba(0,0,0,.7);color:#fff;border-radius:50%;width:1.5rem;height:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700;line-height:1;transition:.2s}
    .remove-image-btn:hover{background:rgba(239,68,68,.9)}
    .tab-btn{cursor:pointer;padding:.75rem 1rem;border-bottom:3px solid transparent;transition:.3s;font-weight:500;white-space:nowrap}
    .tab-btn.active{color:#4f46e5;border-bottom-color:#4f46e5}
    .tab-content{display:none}
    .tab-content.active{display:block}
  </style>
</head>
<body class="text-gray-800">

  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-bold text-indigo-700">æ•™å­¸å¹³å°æ¸¬é©—é¡Œç›®ç”Ÿæˆå™¨</h1>
      <p class="text-lg text-gray-500 mt-3">v6.0ï¼ˆServer-Proxyï¼‰ï½œé‡‘é‘°ç”±ä¼ºæœç«¯ä¿è­·ï¼Œä½¿ç”¨è€…ç„¡éœ€è¼¸å…¥</p>
    </header>

    <main class="max-w-4xl mx-auto space-y-8">
      <!-- Step 0: Provider -->
      <div class="bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
        <h2 class="text-2xl font-bold mb-4 text-indigo-600 flex items-center">
          <span class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3">ğŸ§ </span>é¸æ“‡ AI æ¨¡å‹
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">AI æ¨¡å‹ä¾›æ‡‰å•†ï¼š</label>
            <select id="ai-provider-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="google" selected>Google Gemini</option>
              <option value="openai">OpenAI (ChatGPT)</option>
            </select>
          </div>
          <div class="text-sm text-gray-500 flex items-end">ä¼ºæœç«¯ä»£ç†å·²å•Ÿç”¨ï¼Œå‰ç«¯ä¸æœƒæ¥è§¸ API é‡‘é‘°ã€‚</div>
        </div>
      </div>

      <!-- Step 1: Input -->
      <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
        <h2 class="text-2xl font-bold mb-5 text-indigo-600 flex items-center">
          <span class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3">1</span>æä¾›å…§å®¹
        </h2>

        <div class="border-b border-gray-200 mb-6 overflow-x-auto">
          <nav class="-mb-px flex space-x-2 md:space-x-4" aria-label="Tabs">
            <button id="tab-paste-text" class="tab-btn active">ğŸ“‹ è²¼ä¸Šæ–‡å­—</button>
            <button id="tab-upload-file" class="tab-btn">ğŸ“„ ä¸Šå‚³æª”æ¡ˆ</button>
            <button id="tab-upload-image" class="tab-btn">ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡</button>
            <button id="tab-ai-generate" class="tab-btn">âœ¨ AIç”Ÿæˆå…§æ–‡</button>
          </nav>
        </div>

        <!-- paste -->
        <div id="content-paste-text" class="tab-content active">
          <label class="block text-sm font-medium text-gray-700 mb-1">è²¼ä¸Šæ–‡ç« æˆ–æ•™å­¸å…§å®¹ï¼š</label>
          <textarea id="text-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„æ•™å­¸æ–‡å­—å…§å®¹..."></textarea>
          <div class="flex justify-end mt-2">
            <button id="copy-content-btn" class="bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 transition duration-300 flex items-center text-sm hidden">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              è¤‡è£½æ–‡ç« å…§å®¹
            </button>
          </div>
        </div>

        <!-- file -->
        <div id="content-upload-file" class="tab-content">
          <label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šå‚³æ–‡å­—æª”ï¼š</label>
          <label for="file-input" class="flex flex-col items-center justify-center w-full h-48 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:border-indigo-400 hover:bg-indigo-50">
            <span class="font-medium text-gray-600">é»æ“Šæ­¤è™•ä¸Šå‚³æ–‡å­—æª” <span class="text-indigo-600">æˆ–æ‹–æ›³æª”æ¡ˆåˆ°é€™è£¡</span></span>
            <p class="text-xs text-gray-500 mt-1">æ”¯æ´ .txt åŠ .pdf æ ¼å¼</p>
          </label>
          <input type="file" id="file-input" class="hidden" accept=".txt,.pdf">
          <p id="file-name-display" class="mt-2 text-sm text-center text-gray-600"></p>
        </div>

        <!-- image -->
        <div id="content-upload-image" class="tab-content">
          <div class="flex items-start gap-2 mb-2">
            <span class="px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-700">æç¤º</span>
            <p class="text-xs text-yellow-700">åœ–ç‰‡ç†è§£åƒ…æ”¯æ´ <b>Google Gemini</b>ã€‚åˆ‡æ›ç‚º OpenAI æ™‚æœƒè‡ªå‹•æ¸…ç©ºåœ–ç‰‡ã€‚</p>
          </div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šå‚³åœ–ç‰‡ (æ”¯æ´å¤šå¼µ)ï¼š</label>
          <label for="image-input" class="flex flex-col items-center justify-center w-full h-32 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:border-indigo-400 hover:bg-indigo-50">
            <span class="font-medium text-gray-600">é»æ“Šæ­¤è™•ä¸Šå‚³åœ–ç‰‡ <span class="text-indigo-600">æˆ–æ‹–æ›³æª”æ¡ˆåˆ°é€™è£¡</span></span>
            <p class="text-xs text-gray-500 mt-1">æ”¯æ´ .jpg, .png, .gif, .webpï¼ˆåƒ… Geminiï¼‰</p>
          </label>
          <input type="file" id="image-input" class="hidden" accept="image/*" multiple>
          <div id="image-preview-container" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- AI generate -->
        <div id="content-ai-generate" class="tab-content">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">è«‹è¼¸å…¥æ¸¬é©—ä¸»é¡Œã€å–®å­—æˆ–èªè©ï¼š</label>
              <input type="text" id="topic-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="ä¾‹å¦‚ï¼šå…‰åˆä½œç”¨ã€æ°¸çºŒç™¼å±•ã€apple, banana, run...">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">è«‹é¸æ“‡å­¸ç”Ÿç¨‹åº¦ (K12)ï¼š</label>
              <select id="student-level-select" class="w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="1-2" selected>ä½å¹´ç´š</option>
                <option value="3-4">ä¸­å¹´ç´š</option>
                <option value="5-6">é«˜å¹´ç´š</option>
                <option value="7-9">åœ‹ä¸­</option>
                <option value="9-12">é«˜ä¸­</option>
              </select>
            </div>
            <button id="generate-content-btn" class="w-full bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-300 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
              ç”Ÿæˆå­¸ç¿’å…§æ–‡
            </button>
            <p class="text-xs text-center text-gray-500">AI æœƒè‡ªå‹•å°‡çŸ­æ–‡å¡«å…¥ã€Œè²¼ä¸Šæ–‡å­—ã€ã€‚</p>
          </div>
        </div>
      </div>

      <!-- Step 2: Options -->
      <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
        <h2 class="text-2xl font-bold mb-5 text-indigo-600 flex items-center">
          <span class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3">2</span>è¨­å®šé¸é …
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">é¡Œç›®æ•¸é‡ï¼š</label>
            <input type="number" id="num-questions" value="5" min="1" max="50" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">åŒ¯å‡ºæ ¼å¼ï¼š</label>
            <select id="format-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-[50px]">
              <option value="" disabled selected>è«‹é¸æ“‡...</option>
              <option value="wordwall">Wordwall</option>
              <option value="kahoot">Kahoot!</option>
              <option value="wayground">Wayground</option>
              <option value="loilonote">LoiLoNote</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">é¡Œç›®é¡å‹ï¼š</label>
            <select id="question-type-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-[50px]">
              <option value="multiple_choice" selected>é¸æ“‡é¡Œ</option>
              <option value="true_false">æ˜¯éé¡Œ</option>
              <option value="mixed">æ˜¯é+é¸æ“‡é¡Œ</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">é¡Œç›®é›£åº¦ï¼š</label>
            <select id="difficulty-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-[50px]">
              <option value="ä¸­ç­‰" selected>ä¸­ç­‰ (é è¨­)</option>
              <option value="ç°¡å–®">ç°¡å–®</option>
              <option value="å›°é›£">å›°é›£</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="mt-8">
        <button id="generate-and-download-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:-translate-y-1 flex items-center justify-center text-xl shadow-lg hover:shadow-xl hover:shadow-indigo-500/30">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/></svg>
          âœ¨ ä¸€éµ AI ç”Ÿæˆä¸¦ä¸‹è¼‰
        </button>
      </div>
    </main>

    <footer class="text-center mt-12 text-sm text-gray-500">
      <p>v6.0 (Server-Proxy) | <a href="https://bit.ly/Aliang" target="_blank" class="text-indigo-500 hover:underline">ä¸«äº®æ ¡é•·ç·´åŠŸåŠ</a></p>
    </footer>
  </div>

  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl flex flex-col items-center">
      <div class="loader"></div>
      <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">AI ç‚ºæ‚¨ç”Ÿæˆä¸­...</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transition-opacity duration-300">
    <p id="toast-message"></p>
  </div>

<script>
  // pdf.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

  // DOM
  const textInput = document.getElementById('text-input');
  const fileInput = document.getElementById('file-input');
  const fileNameDisplay = document.getElementById('file-name-display');
  const imageInput = document.getElementById('image-input');
  const imagePreviewContainer = document.getElementById('image-preview-container');
  const numQuestionsInput = document.getElementById('num-questions');
  const formatSelect = document.getElementById('format-select');
  const generateAndDownloadBtn = document.getElementById('generate-and-download-btn');
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingText = document.getElementById('loading-text');
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  const questionTypeSelect = document.getElementById('question-type-select');
  const difficultySelect = document.getElementById('difficulty-select');
  const tabPasteText = document.getElementById('tab-paste-text');
  const tabUploadFile = document.getElementById('tab-upload-file');
  const tabUploadImage = document.getElementById('tab-upload-image');
  const tabAiGenerate = document.getElementById('tab-ai-generate');
  const contentPasteText = document.getElementById('content-paste-text');
  const contentUploadFile = document.getElementById('content-upload-file');
  const contentUploadImage = document.getElementById('content-upload-image');
  const contentAiGenerate = document.getElementById('content-ai-generate');
  const topicInput = document.getElementById('topic-input');
  const generateContentBtn = document.getElementById('generate-content-btn');
  const studentLevelSelect = document.getElementById('student-level-select');

  // Tabs
  const tabs=[tabPasteText,tabUploadFile,tabUploadImage,tabAiGenerate];
  const contents=[contentPasteText,contentUploadFile,contentUploadImage,contentAiGenerate];
  tabs.forEach((tab,i)=>tab.addEventListener('click',()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    contents.forEach(c=>c.classList.remove('active'));
    tab.classList.add('active'); contents[i].classList.add('active');
  }));

  // Toast
  function showToast(msg, type='success'){
    toastMessage.textContent = msg;
    toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 ${type==='success'?'bg-green-500':'bg-red-500'}`;
    toast.classList.remove('opacity-0');
    setTimeout(()=>toast.classList.add('opacity-0'), 4000);
  }

  // Default time by difficulty
  function defaultTimeByDifficulty(d){ return d==='ç°¡å–®'?20 : d==='å›°é›£'?45 : 30; }

  // æ­£ç¢ºç­”æ¡ˆ â†’ ç´¢å¼•é™£åˆ—
  function toIndexArray(correctRaw, options){
    if(Array.isArray(correctRaw)){
      const out = [];
      const letters = ['A','B','C','D','E','F','G'];
      correctRaw.forEach(v=>{
        if(Number.isInteger(v)) out.push(v>=1? v-1 : v);
        else if(typeof v==='string'){
          const s=v.trim(); const L=letters.indexOf(s.toUpperCase());
          if(L>=0) out.push(L);
          else {
            const oi = options.findIndex(opt=>String(opt).trim()===s);
            if(oi>=0) out.push(oi);
            const num = parseInt(s,10); if(Number.isInteger(num)) out.push(num>=1?num-1:num);
          }
        }
      });
      return [...new Set(out)].filter(i=>i>=0 && i<options.length);
    }
    if(Number.isInteger(correctRaw)) return [correctRaw>=1?correctRaw-1:correctRaw].filter(i=>i>=0 && i<options.length);
    if(typeof correctRaw==='string'){
      const s=correctRaw.trim();
      if(/[,\uFF0C\u3001]/.test(s)) return toIndexArray(s.split(/[,\uFF0C\u3001]/).map(x=>x.trim()).filter(Boolean), options);
      const letters = ['A','B','C','D','E','F','G']; const L=letters.indexOf(s.toUpperCase()); if(L>=0) return [L];
      const oi = options.findIndex(opt=>String(opt).trim()===s); if(oi>=0) return [oi];
      const num = parseInt(s,10); if(Number.isInteger(num)) return [num>=1?num-1:num].filter(i=>i>=0 && i<options.length);
    }
    return [];
  }

  // æ¨™æº–åŒ–åˆ° MC çµæ§‹
  function normalizeToMC(q, difficulty){
    // TF â†’ è½‰ MC
    if(q && Object.prototype.hasOwnProperty.call(q,'is_correct')){
      return {
        text: q.text ?? q.question ?? q.title ?? q.prompt ?? q.stem ?? '',
        options: ['æ˜¯','å¦'],
        correct: [q.is_correct ? 0 : 1],
        time: Number.isFinite(q.time) ? q.time : defaultTimeByDifficulty(difficulty),
        explanation: q.explanation || q.reason || ''
      };
    }
    // MC é¡Œæ–‡æœ¬
    const text = q?.text ?? q?.question ?? q?.title ?? q?.prompt ?? q?.stem ?? '';
    // é¸é …
    let options = [];
    if(Array.isArray(q?.options)) options = q.options.slice();
    else if(Array.isArray(q?.choices)) options = q.choices.slice();
    else if(Array.isArray(q?.answers)) options = q.answers.slice();
    else if(q?.options && typeof q.options==='object'){ options = Object.keys(q.options).sort().map(k=>q.options[k]); }
    else if(q?.choices && typeof q.choices==='object'){ options = Object.keys(q.choices).sort().map(k=>q.choices[k]); }
    options = options.filter(v=>v!==undefined && v!==null).map(v=>String(v));
    while(options.length < 4) options.push('');

    // æ­£ç¢ºç­”æ¡ˆ
    let correct =
      toIndexArray(q?.correct, options) ||
      toIndexArray(q?.correct_index, options) ||
      toIndexArray(q?.correct_indices, options) ||
      toIndexArray(q?.correctOption, options) ||
      toIndexArray(q?.correctOptions, options) ||
      toIndexArray(q?.answer, options) ||
      toIndexArray(q?.answers, options) ||
      [];
    if(correct.length===0) correct = [0];

    return {
      text,
      options,
      correct,
      time: Number.isFinite(q?.time) ? q.time : defaultTimeByDifficulty(difficulty),
      explanation: q?.explanation || q?.reason || ''
    };
  }

  // åŒ¯å‡º
  function exportFile(format, questionType, questions, difficulty){
    if(!Array.isArray(questions) || questions.length===0){ showToast('æ²’æœ‰å¯åŒ¯å‡ºçš„é¡Œç›®ï¼','error'); return; }
    const standardMCQs = questions.filter(Boolean).map(q => normalizeToMC(q, difficulty));
    let data, filename;
    try{
      switch(format){
        case 'wordwall':
          data = standardMCQs.map(q=>({
            'å•é¡Œ': q.text || '',
            'é¸é …1': q.options?.[0] ?? '', 'é¸é …2': q.options?.[1] ?? '',
            'é¸é …3': q.options?.[2] ?? '', 'é¸é …4': q.options?.[3] ?? '',
            'æ­£ç¢ºé¸é …': (Array.isArray(q.correct)&&q.correct.length>0)? (q.correct[0]+1) : '',
          }));
          filename='Wordwall_Quiz.xlsx';
          break;
        case 'kahoot': {
          const kahootData = [
            ['Kahoot Quiz Template'],
            ['Add questions, answers, and time limits. Have fun!'],
            [], [],
            ['Question','Answer 1','Answer 2','Answer 3','Answer 4','Time limit (sec)','Correct answer(s)']
          ];
          standardMCQs.forEach(q=>{
            const corr = Array.isArray(q.correct)? q.correct : [];
            kahootData.push([
              q.text || '',
              q.options?.[0] ?? '', q.options?.[1] ?? '', q.options?.[2] ?? '', q.options?.[3] ?? '',
              Number.isFinite(q.time) ? q.time : defaultTimeByDifficulty(difficulty),
              corr.map(i=>i+1).join(',')
            ]);
          });
          const ws = XLSX.utils.aoa_to_sheet(kahootData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
          XLSX.writeFile(wb, 'Kahoot_Quiz.xlsx');
          showToast('Kahoot æª”æ¡ˆå·²ä¸‹è¼‰ï¼','success');
          return;
        }
        case 'wayground':
          data = standardMCQs.map(q=>({
            'Question Text': q.text || '',
            'Question Type': (Array.isArray(q.correct)&&q.correct.length>1)? 'Checkbox':'Multiple Choice',
            'Option 1': q.options?.[0] ?? '', 'Option 2': q.options?.[1] ?? '',
            'Option 3': q.options?.[2] ?? '', 'Option 4': q.options?.[3] ?? '',
            'Option 5': '',
            'Correct Answer': (Array.isArray(q.correct)? q.correct:[]).map(i=>i+1).join(','),
            'Time in seconds': Number.isFinite(q.time) ? q.time : defaultTimeByDifficulty(difficulty),
            'Image Link': '',
            'Answer explanation': q.explanation || ''
          }));
          filename='Wayground_Quiz.xlsx';
          break;
        case 'loilonote':
          data = standardMCQs.map(q=>({
            'å•é¡Œï¼ˆè«‹å‹¿ç·¨è¼¯æ¨™é¡Œï¼‰': q.text || '',
            'å‹™å¿…ä½œç­”ï¼ˆè‹¥æ­¤å•é¡Œéœ€è¦å›ç­”ï¼Œè«‹è¼¸å…¥1ï¼‰': 1,
            'æ¯é¡Œå¾—åˆ†ï¼ˆæœªå¡«å…¥çš„éƒ¨åˆ†å°‡è¢«è‡ªå‹•è¨­ç‚º1ï¼‰': 1,
            'æ­£ç¢ºç­”æ¡ˆçš„é¸é …ï¼ˆè‹¥æœ‰è¤‡æ•¸æ­£ç¢ºç­”æ¡ˆé¸é …ï¼Œè«‹ç”¨ã€Œã€ã€æˆ–ã€Œ , ã€ä¾†åˆ†éš”é¸é …ç·¨è™Ÿï¼‰': (Array.isArray(q.correct)? q.correct:[]).map(i=>i+1).join(','),
            'èªªæ˜': q.explanation || '',
            'é¸é …1': q.options?.[0] ?? '', 'é¸é …2': q.options?.[1] ?? '',
            'é¸é …3': q.options?.[2] ?? '', 'é¸é …4': q.options?.[3] ?? '',
          }));
          filename='LoiLoNote_Quiz.xlsx';
          break;
        default: throw new Error('Unknown format');
      }
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      XLSX.writeFile(wb, filename);
      showToast(`${format.charAt(0).toUpperCase()+format.slice(1)} æª”æ¡ˆå·²ä¸‹è¼‰ï¼`,'success');
    }catch(err){
      console.error('Export failed:', err);
      showToast('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤ã€‚','error');
    }
  }

  // æ–‡å­—/æª”æ¡ˆ/åœ–ç‰‡è™•ç†
  fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) { fileNameDisplay.textContent = ''; return; }
    fileNameDisplay.textContent = `å·²é¸æ“‡æª”æ¡ˆï¼š${file.name}`;
    const reader = new FileReader();
    if (file.type === 'application/pdf') {
      reader.onload = async (e) => {
        const typedarray = new Uint8Array(e.target.result);
        try {
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let text = '';
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            let pageText = '';
            content.items.forEach(item => {
              pageText += item.str;
              pageText += item.hasEOL ? '\n' : ' ';
            });
            text += pageText.trim() + '\n\n';
          }
          textInput.value = text;
        } catch (error) {
          console.error("è®€å–PDFå¤±æ•—:", error);
          showToast("ç„¡æ³•è®€å–æ­¤PDFæª”æ¡ˆã€‚", "error");
          fileNameDisplay.textContent = '';
        }
      };
      reader.readAsArrayBuffer(file);
    } else {
      reader.onload = (e) => { textInput.value = e.target.result; };
      reader.readAsText(file);
    }
  });

  let uploadedImages = [];
  const aiProviderSelect = document.getElementById('ai-provider-select');
  imageInput.addEventListener('change', (event) => {
    const files = event.target.files;
    if (!files) return;
    imagePreviewContainer.innerHTML = '';
    uploadedImages = [];
    Array.from(files).forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const fullBase64 = e.target.result;
        const base64Data = fullBase64.split(',')[1];
        const imageObject = { id: Date.now() + index, type: file.type, data: base64Data };
        uploadedImages.push(imageObject);
        const previewWrapper = document.createElement('div');
        previewWrapper.className = 'image-preview-item';
        const imgElement = document.createElement('img');
        imgElement.src = fullBase64;
        imgElement.className = 'w-full h-32 object-cover rounded-lg shadow-md';
        const removeBtn = document.createElement('div');
        removeBtn.className = 'remove-image-btn';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => {
          uploadedImages = uploadedImages.filter(img => img.id !== imageObject.id);
          previewWrapper.remove();
        };
        previewWrapper.appendChild(imgElement);
        previewWrapper.appendChild(removeBtn);
        imagePreviewContainer.appendChild(previewWrapper);
      };
      reader.readAsDataURL(file);
    });
  });

  aiProviderSelect.addEventListener('change', () => {
    const provider = aiProviderSelect.value;
    if (provider !== 'google' && uploadedImages.length > 0) {
      uploadedImages = [];
      imagePreviewContainer.innerHTML = '';
      showToast('å·²åˆ‡æ›è‡³é Geminiï¼Œç‚ºé¿å…éŒ¯èª¤å·²æ¸…é™¤ä¸Šå‚³åœ–ç‰‡ã€‚', 'error');
    }
  });

  // ç”Ÿæˆæ•™æçŸ­æ–‡ï¼ˆå‘¼å« /api/generate-contentï¼‰
  async function generateContentFromTopic() {
    const topic = topicInput.value;
    const studentLevel = studentLevelSelect.value;
    const provider = aiProviderSelect.value;

    if (!topic.trim()) { showToast('è«‹è¼¸å…¥ä¸€å€‹ä¸»é¡Œã€å–®å­—æˆ–èªè©ï¼', 'error'); return; }

    loadingOverlay.classList.remove('hidden');
    loadingText.textContent = 'AI ç‚ºæ‚¨ç”Ÿæˆå…§æ–‡ä¸­...';
    try {
      const resp = await fetch('/api/generate-content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider, topic, studentLevel })
      });
      if (!resp.ok) throw new Error((await resp.json()).error || 'ç”Ÿæˆå¤±æ•—');
      const data = await resp.json();
      textInput.value = data.text || '';
      if (data.text) { showToast('å­¸ç¿’å…§æ–‡å·²æˆåŠŸç”Ÿæˆï¼','success'); }
    } catch (e) {
      console.error(e); showToast('ç”Ÿæˆå¤±æ•—ï¼š' + (e.message||e),'error');
    } finally {
      loadingOverlay.classList.add('hidden');
    }
  }

  // ä¸»æµç¨‹ï¼ˆæ‰¹æ¬¡ï¼‰
  async function handleGenerateAndDownload(){
    const text = textInput.value;
    const totalQuestions = parseInt(numQuestionsInput.value,10);
    const selectedFormat = formatSelect.value;
    const questionType = questionTypeSelect.value;
    const difficulty = difficultySelect.value;
    const provider = aiProviderSelect.value;

    if(!text.trim() && uploadedImages.length===0){ showToast('è«‹å…ˆè¼¸å…¥æ–‡å­—ã€æˆ–ä¸Šå‚³åœ–ç‰‡ï¼','error'); return; }
    if(uploadedImages.length>0 && provider!=='google'){ showToast('OpenAI ä¸æ”¯æ´åœ–ç‰‡è¼¸å…¥ï¼Œè«‹æ”¹ç”¨ Google Gemini æˆ–ç§»é™¤åœ–ç‰‡ã€‚','error'); return; }
    if(!selectedFormat){ showToast('è«‹é¸æ“‡åŒ¯å‡ºæª”æ¡ˆæ ¼å¼ï¼','error'); return; }
    if(totalQuestions<=0){ showToast('é¡Œç›®æ•¸é‡å¿…é ˆå¤§æ–¼ 0ï¼','error'); return; }

    loadingOverlay.classList.remove('hidden');
    loadingText.textContent = 'AI ç‚ºæ‚¨ç”Ÿæˆé¡Œç›®ä¸­...';
    try{
      const BATCH_SIZE = 8;
      const numBatches = Math.ceil(totalQuestions/BATCH_SIZE);
      let all = [];
      for(let i=0;i<numBatches;i++){
        const need = Math.min(BATCH_SIZE, totalQuestions-all.length);
        const part = await generateSingleBatch(need, questionType, difficulty, text, uploadedImages, selectedFormat);
        all = all.concat(part||[]);
      }
      if(all.length===0) throw new Error('AI æœªèƒ½ç”Ÿæˆä»»ä½•é¡Œç›®ã€‚');
      exportFile(selectedFormat, questionType, all, difficulty);
    }catch(e){
      console.error(e); showToast(e.message||'ç”Ÿæˆå¤±æ•—','error');
    }finally{
      loadingOverlay.classList.add('hidden');
    }
  }

  // å‘¼å« /api/generate-questions
  async function generateSingleBatch(questionsInBatch, questionType, difficulty, text, images, selectedFormat){
    const provider = aiProviderSelect.value;
    const resp = await fetch('/api/generate-questions',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ provider, questionType, difficulty, selectedFormat, questionsInBatch, text, images })
    });
    if(!resp.ok) throw new Error((await resp.json()).error||'ç”Ÿæˆå¤±æ•—');
    const data = await resp.json();
    return data.questions || [];
  }

  // ç¶å®š
  document.addEventListener('DOMContentLoaded', ()=>{});
  generateAndDownloadBtn.addEventListener('click', handleGenerateAndDownload);
  generateContentBtn.addEventListener('click', generateContentFromTopic);
</script>
</body>
</html>
